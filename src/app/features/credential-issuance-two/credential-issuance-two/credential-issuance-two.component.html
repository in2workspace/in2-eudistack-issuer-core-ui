@let power = powerFormSchema$();
@let selectedCredentialType = selectedCredentialType$();

<div class="page-container">
  <h1>{{ "credentialIssuance.title" | translate }}</h1> 
  <div class="main-container">
    <!-- DYNAMIC CONTAINER (LEFT SIDE)-->
    <div class="dynamic-container">
      <mat-card>
        <!-- CREDENTIAL TYPE SELECTOR -->
         <mat-card-content>
          <div class="type-selector-container">
            <h2>{{ "credentialIssuance.select-type" | translate }}</h2>
            <mat-form-field appearance="fill">
              <!-- todo show select trigger -->
              <!-- todo this or title? <mat-label>{{ "credentialIssuance.select-type" | translate }}</mat-label> -->
              <mat-select 
                #select
                [value]="selectedCredentialType" 
                (selectionChange)="onSelectionChange($event.value, select)">
                @for(credentialType of credentialTypesArr; track $index){
                  <mat-option 
                    [value]="credentialType">
                    {{ credentialType }}
                  </mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>

          <!-- CREDENTIAL DATA CONTAINER -->
          <div class="credential-data-container">
            <div class="keys-container">
              @if(selectedCredentialType === 'LEARCredentialMachine'){
              <!-- KEY-GENERATOR -->
                <app-key-generator (updateKeys)="updateKeys($event)"></app-key-generator>
              }
            </div>
            <div class="form-container">
              <!-- MAIN FORM -->
              @let credentialFormSchema = credentialFormSchema$();
              @if (credentialFormSchema && form) {
                    <form [formGroup]="form!" (ngSubmit)="onSubmit()" novalidate>
                      <!--  todo traslladar lÃ²gica al builder? -->
                      @for (field of credentialFormSchema; track field.key) {
                        @if(asSigner || (!asSigner && field.display !== 'pref_side')){
                          <!--  All first-level controls are currently groups -->
                          @if(field.type === 'group'){ 
                            <h2 [class]="field.classes">{{ "credentialIssuance." + field.key | translate | titlecase }}</h2>
                            @for(subfield of field.groupFields; track subfield.key){
                              <div class="form-fields">
                                <app-dynamic-field [fieldName$]="subfield.key" [fieldSchema$]="subfield" [abstractControl$]="form!.get(field.key)!"></app-dynamic-field>
                              </div>
                            }
                          }
                        }
                      }
      
                      <!-- POWER FORM -->
                      <div class="power-container">
                        @if(power){
                          <app-power-two [powersInput]="power.power" (formChanges)="updatePowers($event)"></app-power-two>
                        }
                      </div>

                      <!-- <button mat-raised-button color="primary" type="submit" [disabled]="!isGlobalValid$()">Submit</button> -->
                      <!-- todo restore disabled -->
                       <div class="buttons-container">
                         <button mat-flat-button type="submit">{{"credentialIssuance.cancel" | translate }}</button>
                         <button mat-raised-button color="primary" type="submit">{{"credentialIssuance.create-credential" | translate }}</button>
                       </div>
                    </form>
                  }
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- STATIC COTNAINER (RIGHT SIDE)-->
    <div class="static-container">
      @if(!asSigner && staticData$()){
        @for(data of staticData$() | keyvalue; track $index){
          <h2>{{ "credentialIssuance." + data.key | translate | titlecase }}</h2>
          @for(fields of data.value | keyvalue; track $index){
            <h5>{{ "credentialIssuance." + fields.key | translate }}</h5>
            <p>{{ fields.value }}</p>
          }
        }
      }
    </div>
  </div>
</div>

