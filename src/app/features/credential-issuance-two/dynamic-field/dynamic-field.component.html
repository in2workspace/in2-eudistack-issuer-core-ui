@let fieldSchema = fieldSchema$();
@let fieldName = fieldName$();
@let control = control$();

@if(abstractControl$() && fieldSchema) {
  @if (fieldSchema.type === 'group' && groupFields$()) {
    <!-- Per als grups, mostrem el FormGroup especÃ­fic del camp -->
    <mat-card class="mb-4">
      <mat-card-content [formGroup]="group$()!">
        @for (field of fieldSchema.groupFields | keyvalue; track $index) {
          <app-dynamic-field 
            [fieldName$]="field.key" 
            [fieldSchema$]="field.value" 
            [abstractControl$]="group$()!">
          </app-dynamic-field>
        }
      </mat-card-content>
    </mat-card>
  } @else {
    <!-- Controls individuals -->
    <mat-form-field appearance="outline" class="w-full" [formGroup]="parentFormGroup$()">
      <mat-label>{{ fieldName }}</mat-label>
      <!-- todo use switch -->
       @let controlType = fieldSchema.controlType;
      @if (controlType === 'number' || controlType === 'text') {
        <input matInput [type]="controlType" [formControlName]="fieldName" [id]="fieldName" [class]="fieldSchema.class"/>
      }@else if(controlType === 'selector'){
          <mat-select [formControlName]="fieldName" [id]="fieldName" [class]="fieldSchema.class">
            <mat-option value="">Select a {{fieldName}}</mat-option>
            @for(option of fieldSchema.multiOptions; track $index){
              <mat-option [value]="option.value">
                {{ option.label }}
              </mat-option>
            }
          </mat-select>
      }
      @if (control?.invalid && control?.touched) {
        <mat-error>{{ control!.errors | firstElement | translate }}</mat-error>
      }

    </mat-form-field>
  }
}
