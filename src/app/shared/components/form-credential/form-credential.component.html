<app-navbar></app-navbar>
<div *ngIf="viewMode === 'detail'">
  <button type="button" [routerLink]="['/organization/credentials']" class="back-button" aria-label="Back to credentials">
    <mat-icon class="back-icon" fontIcon="arrow_back"></mat-icon>
  </button>
</div>
<div class="page-container">
  <h1>{{ title }}</h1>
  <div class="credential-container">
    <div class="mandatee-container">
      <mat-card>
        <!-- MANDATEE -->
        <h2>Mandatee</h2>
        <mat-card-content>
          <form #formDirective="ngForm" (ngSubmit)="openSubmitDialog()" novalidate>
            <!-- FIRST NAME -->
            <mat-form-field>
              <mat-label>{{ "mandatee.firstnameid" | translate }}</mat-label>
              <input
                [disabled]="isDisabled"
                matInput
                [(ngModel)]="credential.firstName"
                name="first_name"
                appUnicodeValidator
                minlength="2"
                [appMaxLength]="50"
                required
                #firstName="ngModel"
              />
              <mat-error *ngIf="firstName.touched">
                <ng-container *ngIf="firstName.errors?.['required']">
                  {{ translate.instant("error.form.required") }}
                </ng-container>
                <ng-container *ngIf="firstName.errors?.['invalidUnicode']">
                  {{ translate.instant("error.form.invalid_character") }}
                </ng-container>
                <ng-container *ngIf="firstName.errors?.['minlength']">
                  {{ translate.instant("error.form.min_2") }}
                </ng-container>
                <ng-container *ngIf="firstName.errors?.['maxlengthExceeded']">
                  {{ translate.instant("error.form.max_50") }}
                </ng-container>
              </mat-error>
            </mat-form-field>
            <!-- LAST NAME -->
            <mat-form-field>
              <mat-label>{{ "mandatee.last_name" | translate }}</mat-label>
              <input
                [disabled]="isDisabled"
                matInput
                [(ngModel)]="credential.lastName"
                name="last_name"
                required
                minlength="2"
                appUnicodeValidator
                [appMaxLength]="50"
                #lastName="ngModel"
              />
              <mat-error *ngIf="lastName.touched">
                <ng-container *ngIf="lastName.errors?.['required']">
                  {{ translate.instant("error.form.required") }}
                </ng-container>
                <ng-container *ngIf="lastName.errors?.['invalidUnicode']">
                  {{ translate.instant("error.form.invalid_character") }}
                </ng-container>
                <ng-container *ngIf="lastName.errors?.['minlength']">
                  {{ translate.instant("error.form.min_2") }}
                </ng-container>
                <ng-container *ngIf="lastName.errors?.['maxlengthExceeded']">
                  {{ translate.instant("error.form.max_50") }}
                </ng-container>
              </mat-error>
            </mat-form-field>
            <!-- EMAIL -->
            <mat-form-field>
              <mat-label>{{ "mandatee.email" | translate }}</mat-label>
              <input
                [disabled]="isDisabled"
                matInput
                [(ngModel)]="credential.email"
                name="email"
                required
                appEmailValidator
                #email="ngModel"
              />
              <mat-error *ngIf="email.touched">
                <ng-container *ngIf="email.errors?.['required']">
                  {{ translate.instant("error.form.required") }}
                </ng-container>
                <ng-container *ngIf="email.errors?.['emailPatternInvalid']">
                  {{ translate.instant("error.form.email.invalid") }}
                </ng-container>
                <ng-container *ngIf="email.errors?.['emailLocalPartTooLong']">
                  {{ translate.instant("error.form.email.local_part_max") }}
                </ng-container>
                <ng-container *ngIf="email.errors?.['emailDomainTooLong']">
                  {{ translate.instant("error.form.email.domain_part_max") }}
                </ng-container>
                <ng-container *ngIf="email.errors?.['emailMainDomainTooShort']">
                  {{ translate.instant("error.form.email.main_domain_part_min") }}
                </ng-container>
                <ng-container *ngIf="email.errors?.['emailTopLevelDomainTooShort']">
                  {{ translate.instant("error.form.email.top_level_domain_part_min") }}
                </ng-container>
              </mat-error>
            </mat-form-field>
            <!-- NATIONALITY SELECTION -->
            <div class="nationality">
              <mat-form-field>
                <mat-label>{{ "mandatee.nationality" | translate }}</mat-label>
                <mat-select [(ngModel)]="credential.nationality" name="nationality" required>
                  <mat-option [value]="''">- {{ "mandator.select-country" | translate }} -</mat-option>
                  <mat-option *ngFor="let country of countries" [value]="country.name">
                    {{ country.name }}
                  </mat-option>
                </mat-select>
                <mat-error *ngIf="!credential.nationality">
                  {{ translate.instant("error.form.required") }}
                </mat-error>
              </mat-form-field>
            </div>
            <div *ngIf="asSigner && hasIn2OrganizationId">
              <!-- MANDATOR (FORM - AS SIGNER) -->
              <h2 class="mandator-title">Mandator</h2>
              <!-- MANDATOR FIRST NAME -->
              <mat-form-field>
                <mat-label>{{ "mandator.first-name" | translate }}</mat-label>
                <input
                  [disabled]="isDisabled"
                  matInput
                  [(ngModel)]="mandator.commonName"
                  name="commonFirstName"
                  placeholder="Jhon Doe"
                  required
                  appUnicodeValidator
                  minlength="2"
                  [appMaxLength]="50"
                  #mandatorFirstName="ngModel"
                />
                <mat-error *ngIf="mandatorFirstName.touched">
                  <ng-container *ngIf="mandatorFirstName.errors?.['required']">
                    {{ translate.instant("error.form.required") }}
                  </ng-container>
                  <ng-container *ngIf="mandatorFirstName.errors?.['invalidUnicode']">
                    {{ translate.instant("error.form.invalid_character") }}
                  </ng-container>
                  <ng-container *ngIf="mandatorFirstName.errors?.['minlength']">
                    {{ translate.instant("error.form.min_2") }}
                  </ng-container>
                  <ng-container *ngIf="mandatorFirstName.errors?.['maxlengthExceeded']">
                    {{ translate.instant("error.form.max_50") }}
                  </ng-container>
                </mat-error>
              </mat-form-field>
              <!-- MANDATOR LAST NAME -->
              <mat-form-field>
                <mat-label>{{ "mandator.last-name" | translate }}</mat-label>
                <input
                  [disabled]="isDisabled"
                  matInput
                  [(ngModel)]="addedMandatorLastName"
                  name="commonLastName"
                  placeholder="Doe"
                  required
                  appUnicodeValidator
                  minlength="2"
                  [appMaxLength]="50"
                  #mandatorLastName="ngModel"
                />
                <mat-error *ngIf="mandatorLastName.touched">
                  <ng-container *ngIf="mandatorLastName.errors?.['required']">
                    {{ translate.instant("error.form.required") }}
                  </ng-container>
                  <ng-container *ngIf="mandatorLastName.errors?.['invalidUnicode']">
                    {{ translate.instant("error.form.invalid_character") }}
                  </ng-container>
                  <ng-container *ngIf="mandatorLastName.errors?.['minlength']">
                    {{ translate.instant("error.form.min_2") }}
                  </ng-container>
                  <ng-container *ngIf="mandatorLastName.errors?.['maxlengthExceeded']">
                    {{ translate.instant("error.form.max_50") }}
                  </ng-container>
                </mat-error>
              </mat-form-field>
              <!-- MANDATOR EMAIL -->
              <mat-form-field>
                <mat-label>{{ "mandator.email" | translate }}</mat-label>
                <input
                  [disabled]="isDisabled"
                  matInput
                  [(ngModel)]="mandator.emailAddress"
                  name="emailAddress"
                  placeholder="name@mail.com"
                  required
                  appEmailValidator
                  #mandatorEmail="ngModel"
                />
                <mat-error *ngIf="mandatorEmail.touched">
                  <ng-container *ngIf="mandatorEmail.errors?.['required']">
                    {{ translate.instant("error.form.required") }}
                  </ng-container>
                  <ng-container *ngIf="mandatorEmail.errors?.['emailPatternInvalid']">
                    {{ translate.instant("error.form.email.invalid") }}
                  </ng-container>
                  <ng-container *ngIf="mandatorEmail.errors?.['emailLocalPartTooLong']">
                    {{ translate.instant("error.form.email.local_part_max") }}
                  </ng-container>
                  <ng-container *ngIf="mandatorEmail.errors?.['emailDomainTooLong']">
                    {{ translate.instant("error.form.email.domain_part_max") }}
                  </ng-container>
                  <ng-container *ngIf="mandatorEmail.errors?.['emailMainDomainTooShort']">
                    {{ translate.instant("error.form.email.main_domain_part_min") }}
                  </ng-container>
                  <ng-container *ngIf="mandatorEmail.errors?.['emailTopLevelDomainTooShort']">
                    {{ translate.instant("error.form.email.top_level_domain_part_min") }}
                  </ng-container>
                </mat-error>
              </mat-form-field>
              <!-- MANDATOR SERIAL NUMBER -->
              <mat-form-field>
                <mat-label>{{ "mandator.serialNumber" | translate }}</mat-label>
                <input
                  [disabled]="isDisabled"
                  matInput
                  [(ngModel)]="mandator.serialNumber"
                  name="serialNumber"
                  placeholder="123456"
                  pattern="^[a-zA-Z0-9-]+$"
                  minlength="7"
                  [appMaxLength]="15"
                  #serialNumber="ngModel"
                />
                <mat-error *ngIf="serialNumber.touched">
                  <ng-container *ngIf="serialNumber.errors?.['pattern']">
                    {{ translate.instant("error.form.only_letters_numbers_hyphens") }}
                  </ng-container>
                  <ng-container *ngIf="serialNumber.errors?.['minlength']">
                    {{ translate.instant("error.form.min_7") }}
                  </ng-container>
                  <ng-container *ngIf="serialNumber.errors?.['maxlengthExceeded']">
                    {{ translate.instant("error.form.max_15") }}
                  </ng-container>
                </mat-error>
              </mat-form-field>
              <!-- MANDATOR ORGANIZATION NAME -->
              <mat-form-field>
                <mat-label>{{ "mandator.organization" | translate }}</mat-label>
                <input
                  [disabled]="isDisabled"
                  matInput
                  [(ngModel)]="mandator.organization"
                  name="organization"
                  placeholder="Organization Inc"
                  required
                  appOrgNameValidator
                  minlength="2"
                  [appMaxLength]="50"
                  #orgName="ngModel"
                />
                <mat-error *ngIf="orgName.touched">
                  <ng-container *ngIf="orgName.errors?.['required']">
                    {{ translate.instant("error.form.required") }}
                  </ng-container>
                  <ng-container *ngIf="orgName.errors?.['invalidOrgName']">
                    {{ translate.instant("error.form.invalid_character") }}
                  </ng-container>
                  <ng-container *ngIf="orgName.errors?.['minlength']">
                    {{ translate.instant("error.form.min_2") }}
                  </ng-container>
                  <ng-container *ngIf="orgName.errors?.['maxlengthExceeded']">
                    {{ translate.instant("error.form.max_50") }}
                  </ng-container>
                </mat-error>
              </mat-form-field>
              <!-- MANDATOR ORGANIZATION ID -->
              <div class="org-id-hint">
                {{ "mandator.organizationidHint" | translate }}
              </div>
              <mat-form-field>
                <mat-label>{{ "mandator.organizationid" | translate }}</mat-label>
                <input
                  [disabled]="isDisabled"
                  matInput
                  [(ngModel)]="mandator.organizationIdentifier"
                  name="organizationIdentifier"
                  placeholder="1234567"
                  required
                  appOrganizationIdentifierValidator
                  minlength="7"
                  [appMaxLength]="15"
                  #orgId="ngModel"
                />
                <mat-error *ngIf="orgId.touched">
                  <ng-container *ngIf="orgId.errors?.['required']">
                    {{ translate.instant("error.form.required") }}
                  </ng-container>
                  <ng-container *ngIf="orgId.errors?.['startsWithVAT']">
                    {{ translate.instant("error.form.org_id_startsWithVAT") }}
                  </ng-container>
                  <ng-container *ngIf="orgId.errors?.['invalidIdentifier']">
                    {{ translate.instant("error.form.only_letters_and_numbers") }}
                  </ng-container>
                  <ng-container *ngIf="orgId.errors?.['minlength']">
                    {{ translate.instant("error.form.min_7") }}
                  </ng-container>
                  <ng-container *ngIf="orgId.errors?.['maxlengthExceeded']">
                    {{ translate.instant("error.form.max_15") }}
                  </ng-container>
                </mat-error>
              </mat-form-field>
              <!-- MANDATOR COUNTRY -->
              <mat-form-field>
                <mat-label>{{ "mandator.country" | translate }}</mat-label>
                <mat-select
                  [disabled]="isDisabled"
                  [(ngModel)]="mandator.country"
                  name="mandatorCountry"
                  required
                  #mandatorCountry="ngModel"
                >
                  <mat-option [value]="''">- {{ "mandator.select-country" | translate }} -</mat-option>
                  <mat-option *ngFor="let country of countries" [value]="country.name">
                    {{ country.name }}
                  </mat-option>
                </mat-select>
                <!-- Sustituye @if por *ngIf -->
                <mat-error *ngIf="mandatorCountry.touched">
                  <ng-container *ngIf="mandatorCountry.errors?.['required']">
                    {{ translate.instant("error.form.required") }}
                  </ng-container>
                </mat-error>
              </mat-form-field>
            </div>

            <!-- POWERS -->
            <app-power
              [isDisabled]="isDisabled"
              [viewMode]="viewMode"
              [power]="tempPowers"
            ></app-power>
            <div *ngIf="!hasSelectedPower() && !isDisabled" class="power-alert">
              {{ "error.form.no_power" | translate }}
            </div>
            <div *ngIf="!selectedPowersHaveFunction() && !isDisabled" class="power-alert">
              {{ "error.form.no_function" | translate }}
            </div>
            <div class="buttons-container">
              <ng-container *ngIf="viewMode === 'create'; else detailButtons">
                <button
                  class="cancel-button"
                  mat-flat-button
                  type="button"
                  [routerLink]="['/organization/credentials']"
                >
                  {{ "credentialManagement.cancel" | translate }}
                </button>
                <button
                  mat-raised-button
                  color="primary"
                  [disabled]="!formDirective.valid || !hasSelectedPower() || !selectedPowersHaveFunction() || (isLoading$ | async)"
                >
                  {{ "credentialManagement.create" | translate }}
                </button>
              </ng-container>
              <ng-template #detailButtons>
                <!-- SEND REMINDER BUTTON -->
                <ng-container *ngTemplateOutlet="sendReminderButton"></ng-container>
              </ng-template>
            </div>
          </form>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- MANDATOR (SIDE-LABEL - NOT AS SIGNER) -->
    <div *ngIf="!asSigner || !hasIn2OrganizationId" class="mandator-container">
      <h2>Mandator</h2>
      <mat-card-content>
        <h5 class="margin-top-none">{{ "mandator.name" | translate }}</h5>
        <p>{{ mandator.commonName }}</p>
        <h5>{{ "mandator.email" | translate }}</h5>
        <p>{{ mandator.emailAddress }}</p>
        <h5>{{ "mandator.serialNumber" | translate }}</h5>
        <p>{{ mandator.serialNumber }}</p>
        <h5>{{ "mandator.organization" | translate }}</h5>
        <p>{{ mandator.organization }}</p>
        <h5>{{ "mandator.organizationid" | translate }}</h5>
        <p>{{ mandator.organizationIdentifier }}</p>
        <h5>{{ "mandator.country" | translate }}</h5>
        <p>{{ mandator.country }}</p>
      </mat-card-content>
    </div>

    <div *ngIf="asSigner && hasIn2OrganizationId" class="mandator-container signer">
      <div class="mandator-main">
        <h2>Signer</h2>
        <mat-card-content>
          <h5 class="margin-top-none">{{ "mandator.name" | translate }}</h5>
          <p>{{ signer.commonName }}</p>
          <h5>{{ "mandator.email" | translate }}</h5>
          <p>{{ signer.emailAddress }}</p>
          <h5>{{ "mandator.serialNumber" | translate }}</h5>
          <p>{{ signer.serialNumber }}</p>
          <h5>{{ "mandator.organization" | translate }}</h5>
          <p>{{ signer.organization }}</p>
          <h5>{{ "mandator.organizationid" | translate }}</h5>
          <p>{{ signer.organizationIdentifier }}</p>
          <h5>{{ "mandator.country" | translate }}</h5>
          <p>{{ signer.country }}</p>
        </mat-card-content>
      </div>
    </div>
  </div>
</div>

<!-- REUSABLE SEND REMINDER TEMPLATE -->
<ng-template #sendReminderButton>
  <div *ngIf="showReminderButton()" class="btn-reminder">
    <button
      type="button"
      mat-raised-button
      color="primary"
      (click)="triggerSendReminder()"
      [disabled]="isLoading$ | async"
    >
      {{ "credentialDetail.sendReminderConfirm.title" | translate }}
    </button>
  </div>
</ng-template>
